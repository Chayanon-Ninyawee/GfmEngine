#!/bin/bash
set -e  # Exit on error

PROJECT_DIR="@CMAKE_SOURCE_DIR@"
CONTAINER_NAME="temp-container"
IMAGE_NAME="gfmengine-builder-ubuntu20"

if [[ -z "$PROJECT_DIR" || "$PROJECT_DIR" == "/" ]]; then
    echo "Error: PROJECT_DIR is not set or invalid!"
    exit 1
fi

# Build the Docker image
docker build -t "$IMAGE_NAME" "$PROJECT_DIR"

# Prune old images
docker image prune -f

# Run the container
docker run --name "$CONTAINER_NAME" "$IMAGE_NAME"

# Ensure the build directory exists before deleting
if [[ -d "$PROJECT_DIR/ubuntu20/build" ]]; then
    rm -rf "$PROJECT_DIR/ubuntu20/build"
fi
mkdir -p "$PROJECT_DIR/ubuntu20"

# Copy build artifacts
docker cp "$CONTAINER_NAME:/app/build" "$PROJECT_DIR/ubuntu20/build"

# Clean up the container
docker rm "$CONTAINER_NAME"